{% extends 'base/base.html' %}
{% load static %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/paginas/financiamento.css' %}">
{% endblock head %}
{% block content %}
{% comment %}
    COLE ESTE BLOCO DENTRO DO SEU TEMPLATE, 
    NO LOCAL ONDE O CONTEÚDO DA PÁGINA DEVE APARECER.
{% endcomment %}

<div class="financiamento-container">
    <header class="financiamento-header">
        <h1>Ficha de Financiamento</h1>
        <p>Preencha os dados abaixo para enviar sua proposta. Nossa equipe analisará e entrará em contato o mais breve possível.</p>
    </header>
<div class="financiamento-container" id="form-wrapper">
    <form class="financiamento-form" id="main-form" action="{% url 'solicitar_financiamento' %}" method="POST">
        {% csrf_token %}

        <fieldset>
            <legend>Dados Pessoais</legend>
            <div class="form-grid">
                <div class="form-group span-3">
                    <label for="nome">Nome Completo</label>
                    <input type="text" id="nome" name="nome" required>
                </div>
                <div class="form-group span-2">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="cnh">CNH</label>
                    <input type="text" id="cnh" name="cnh">
                </div>
                <div class="form-group">
                    <label for="telefone">Telefone</label>
                    <input type="tel" id="telefone" name="telefone" required>
                </div>
                 <div class="form-group">
                    <label for="celular">Celular</label>
                    <input type="tel" id="celular" name="celular" required>
                </div>
                <div class="form-group">
                    <label for="cpf">CPF</label>
                    <input type="text" id="cpf" name="cpf" required>
                </div>
                <div class="form-group">
                    <label for="estado_civil">Estado Civil</label>
                    <select id="estado_civil" name="estado_civil" required>
                        <option value="">Selecione...</option>
                        <option value="solteiro">Solteiro(a)</option>
                        <option value="casado">Casado(a)</option>
                        <option value="divorciado">Divorciado(a)</option>
                        <option value="viuvo">Viúvo(a)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="data_nascimento">Data Nascimento</label>
                    <input type="date" id="data_nascimento" name="data_nascimento" required>
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend>Dados Residenciais</legend>
            <div class="form-grid">
                <div class="form-group span-2">
                    <label for="endereco">Endereço</label>
                    <input type="text" id="endereco" name="endereco" required>
                </div>
                <div class="form-group">
                    <label for="numero">Número</label>
                    <input type="text" id="numero" name="numero" required>
                </div>
                <div class="form-group">
                    <label for="bairro">Bairro</label>
                    <input type="text" id="bairro" name="bairro" required>
                </div>
                <div class="form-group">
                    <label for="cidade_res">Cidade</label>
                    <input type="text" id="cidade_res" name="cidade_res" required>
                </div>
                <div class="form-group">
                    <label for="uf_res">UF</label>
                    <select id="uf_res" name="uf_res" required>
                        <option value="RJ">RJ</option>
                        </select>
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend>Informações do Financiamento</legend>
            <div class="form-grid">
                <div class="form-group">
                    <label for="marca">Marca do Veículo</label>
                    <input type="text" id="marca" name="marca">
                </div>
                <div class="form-group">
                    <label for="modelo">Modelo</label>
                    <input type="text" id="modelo" name="modelo">
                </div>
                <div class="form-group">
                    <label for="ano_fabricacao">Ano Fabricação</label>
                    <input type="text" id="ano_fabricacao" name="ano_fabricacao">
                </div>
                 <div class="form-group">
                    <label for="entrada">Entrada (Se houver)</label>
                    <input type="text" id="entrada" name="entrada" placeholder="R$">
                </div>
                <div class="form-group">
                    <label for="valor_financiar">Valor a Financiar</label>
                    <input type="text" id="valor_financiar" name="valor_financiar" placeholder="R$" required>
                </div>
                <div class="form-group">
                    <label for="qtd_parcelas">Qtd. Parcelas</label>
                    <select id="qtd_parcelas" name="qtd_parcelas" required>
                        <option value="">Selecione...</option>
                        <option value="12">12x</option>
                        <option value="24">24x</option>
                        <option value="36">36x</option>
                        <option value="48">48x</option>
                        <option value="60">60x</option>
                    </select>
                </div>
            </div>
        </fieldset>

        <div class="form-group span-3">
            <label for="observacao">Observação</label>
            <textarea id="observacao" name="observacao" rows="5"></textarea>
        </div>

        <div class="form-actions">
            <div class="recaptcha-placeholder"></div>
            <button type="submit" class="submit-button" id="submit-button">SOLICITAR FINANCIAMENTO</button>
        </div>
    </form>
</div>
</div>
<script>
   // Adicione este script no seu arquivo JS ou no final do seu template HTML

document.addEventListener('DOMContentLoaded', () => {
    // 1. Seleciona os elementos pelos IDs. Se algum ID estiver errado no HTML, estas variáveis serão 'null'.
    const form = document.getElementById('main-form');
    const submitButton = document.getElementById('submit-button');
    const formWrapper = document.getElementById('form-wrapper');

    // 2. Apenas continua se TODOS os três elementos essenciais forem encontrados na página.
    if (form && submitButton && formWrapper) {
        
        const originalButtonHTML = submitButton.innerHTML;

        form.addEventListener('submit', (event) => {
            // 3. A linha MAIS IMPORTANTE: impede que o navegador recarregue a página!
            event.preventDefault();

            // Ativa o estado de loading
            submitButton.disabled = true;
            submitButton.classList.add('loading');
            submitButton.innerHTML = `<span class="spinner"></span> Enviando...`;
            
            const formData = new FormData(form);
            const url = form.action;

            // Envia a requisição
            fetch(url, {
                method: 'POST',
                body: formData,
            })
            .then(response => {
                if (response.ok) { // Verifica se o status é 2xx (sucesso)
                    return response.json();
                }
                // Se o status for de erro (4xx, 5xx), vai para o .catch()
                return Promise.reject(response);
            })
            .then(data => {
                // SUCESSO: A resposta foi 2xx e o JSON foi lido.
                const successMessageHTML = `
                    <div class="success-message">
                        <h3>✅ Enviado com Sucesso!</h3>
                        <p>${data.message}</p>
                    </div>
                `;
                // Substitui todo o conteúdo do container pela mensagem
                formWrapper.innerHTML = successMessageHTML;
            })
            .catch(error => {
                // ERRO: A resposta foi 4xx/5xx ou houve um erro de rede.
                console.error('Erro na submissão:', error);
                alert('Ocorreu um erro ao enviar sua solicitação. Por favor, verifique os dados e tente novamente.');

                // Restaura o botão para que o usuário possa tentar novamente
                submitButton.disabled = false;
                submitButton.classList.remove('loading');
                submitButton.innerHTML = originalButtonHTML;
            });
        });
    } else {
        // Mensagem de aviso no console se algum elemento não for encontrado. Ajuda a depurar!
        console.warn('O script do formulário não foi executado. Verifique se os IDs "form-wrapper", "main-form" e "submit-button" existem no seu HTML.');
    }
});
</script>
{% endblock content %}