{% extends 'base/base.html' %}
{% load static %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/paginas/pos-vendas.css' %}">
{% endblock head %}
{% block content %}
<div class="container_posvenda">

        <header class="header-posvenda">
            <h1>Canal Pós-Vendas</h1>
            <p>
                Se você ainda está com dúvidas e precisa de ajuda com a compra do seu seminovo, entre em contato com nosso time de vendas. 
                <a href="#">Garanta aqui!</a>
            </p>
        </header>

        <section class="quick-contact-section">
            <h2>Já é cliente Autobots e precisa de ajuda com <span class="highlight">transferências, multas e garantia?</span></h2>
            <a href="https://wa.me/{{contatos.telefone}}" class="whatsapp-button" target="_blank">
                <i class="fab fa-whatsapp"></i> Canal Pós-Vendas
            </a>
            <div class="contact-info">
                <p>Ou ligue: <strong>{{contatos.telefone}}</strong></p>
                <p>Horário de atendimento: Segunda a sexta, de 8h às 18h.</p>
            </div>
        </section>

        <section class="form-section" id="pos-venda-form-container">
    <h2>Se preferir, preencha o formulário abaixo:</h2>
    
    <form class="contact-form" id="pos-venda-form" action="{% url 'enviar_pos_vendas' %}" method="POST">
        {% csrf_token %}
        <div class="form-group">
            <label for="name">Nome</label>
            <input type="text" id="name" name="nome" required>
        </div>
        
        <div class="form-group">
            <label for="cpf">CPF</label>
            <input type="text" id="cpf" name="cpf" required>
        </div>

        <div class="form-group">
            <label for="email">E-mail</label>
            <input type="email" id="email" name="email" required>
        </div>

        <div class="form-group">
            <label for="phone">Telefone</label>
             <input type="tel" id="phone" name="telefone" required>
        </div>

        <div class="form-group">
            <label for="state">Estado</label>
            <select id="state" name="estado" required>
                <option value="">Selecione o estado</option>
                {% for endereco in enderecos %}
                    <option value="{{ endereco.estado }}">{{ endereco.estado }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="city">Cidade</label>
            <select id="city" name="cidade" required>                               
                <option value="">Selecione a cidade</option>
                {% for endereco in enderecos %}
                    <option value="{{ endereco.cidade }}">{{ endereco.cidade }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
    <label for="store">Loja</label>
    <select id="store" name="loja" required>
        <option value="">Selecione a loja</option>
        {% for endereco in enderecos %}
            <option value="{{ endereco.id }}">{{ endereco.nome_loja }}</option>
        {% endfor %}
    </select>
</div>
        
        <div class="form-group">
            <label for="source">Como nos conheceu?</label>
            <input type="text" id="source" name="source">
        </div>
        
        <div class="form-group full-width">
            <label for="message">Mensagem</label>
            <textarea id="message" name="mensagem" required></textarea>
        </div>
        
        <div class="form-group full-width">
            <button type="submit" class="submit-button">ENVIAR</button>
        </div>

    </form>
</section>
        
        <footer class="footer-info">
            <p>A Autobots Veículos com o objetivo de continuar crescendo de forma ética e preservando sua essência, disponibiliza aos seus colaboradores uma ferramenta para relatos de fatos e condutas que não estejam de acordo com os princípios da empresa. A parceria firmada com a Aliant, uma empresa terceirizada, contribuirá para um ambiente de trabalho cada vez mais transparente. Os contatos com o Canal podem ser feitos pelos seguintes meios:</p>
            <ul>
                
                <li>• Envio de e-mail para: <strong>{{contatos.email}}</strong></li>
                <li>• Pelo telefone: <strong>{{contatos.telefone}}</strong></li>
            </ul>
        </footer>

    </div>
    <script>
        
    document.addEventListener('DOMContentLoaded', () => {
        // Seleciona o formulário e o container que o envolve
        const posVendaForm = document.getElementById('pos-venda-form');
        const formContainer = document.getElementById('pos-venda-form-container');

        if (posVendaForm) {
            posVendaForm.addEventListener('submit', (event) => {
                // 1. Impede o recarregamento da página
                event.preventDefault();

                // 2. Coleta os dados do formulário
                const formData = new FormData(posVendaForm);
                const url = posVendaForm.action;

                // 3. Envia os dados para o backend via Fetch
                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // 4. Se a resposta for sucesso, substitui o formulário
                    if (data.status === 'success') {
                        const successMessageHTML = `
                            <div class="success-message-posvenda">
                                <h3>✔️ Solicitação Enviada!</h3>
                                <p>${data.message}</p>
                            </div>
                        `;
                        // Substitui todo o conteúdo do container pela mensagem
                        formContainer.innerHTML = successMessageHTML;
                    } else {
                        // Se houver um erro validado pelo backend
                        alert('Erro: ' + data.message);
                    }
                })
                .catch(error => {
                    // 5. Lida com erros de conexão/rede
                    console.error('Ocorreu um erro na requisição:', error);
                    alert('Não foi possível enviar sua solicitação. Verifique sua conexão e tente novamente.');
                });
            });
        }
    });
</script>
  

{% endblock content %}